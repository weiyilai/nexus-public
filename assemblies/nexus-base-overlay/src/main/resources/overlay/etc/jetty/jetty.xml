<?xml version="1.0"?>
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "https://jetty.org/configure_10_0.dtd">
<Configure id="Server" class="org.eclipse.jetty.server.Server">

  <Arg name="threadPool">
    <New id="threadpool" class="org.sonatype.nexus.bootstrap.jetty.InstrumentedQueuedThreadPool">
      <Set name="maxThreads">400</Set>
    </New>
  </Arg>

  <Arg>
    <New class="org.eclipse.jetty.util.thread.ScheduledExecutorScheduler">
      <Arg name="name"><Property name="jetty.scheduler.name"/></Arg>
      <Arg name="daemon" type="boolean"><Property name="jetty.scheduler.daemon" default="false" /></Arg>
      <Arg name="threads" type="int"><Property name="jetty.scheduler.threads" default="-1" /></Arg>
    </New>
  </Arg>
  <Arg><Ref refid="byteBufferPool"/></Arg>

  <New id="baseHttpConfig" class="org.eclipse.jetty.server.HttpConfiguration">
    <Set name="secureScheme" property="jetty.httpConfig.secureScheme"/>
    <Set name="securePort" property="jetty.httpConfig.securePort"/>
    <Set name="outputBufferSize" property="jetty.httpConfig.outputBufferSize"/>
    <Set name="outputAggregationSize" property="jetty.httpConfig.outputAggregationSize"/>
    <Set name="requestHeaderSize" property="jetty.httpConfig.requestHeaderSize"/>
    <Set name="responseHeaderSize" property="jetty.httpConfig.responseHeaderSize"/>
    <Set name="sendServerVersion" property="jetty.httpConfig.sendServerVersion"/>
    <Set name="sendDateHeader"><Property name="jetty.httpConfig.sendDateHeader" default="false"/></Set>
    <Set name="headerCacheSize" property="jetty.httpConfig.headerCacheSize"/>
    <Set name="delayDispatchUntilContent" property="jetty.httpConfig.delayDispatchUntilContent"/>
    <Set name="maxErrorDispatches" property="jetty.httpConfig.maxErrorDispatches"/>
    <Set name="persistentConnectionsEnabled" property="jetty.httpConfig.persistentConnectionsEnabled"/>
    <Set name="httpCompliance"><Call class="org.eclipse.jetty.http.HttpCompliance" name="from"><Arg><Property name="jetty.httpConfig.compliance" deprecated="jetty.http.compliance" default="RFC7230"/></Arg></Call></Set>
    <Set name="uriCompliance"><Call class="org.eclipse.jetty.http.UriCompliance" name="from"><Arg><Property name="jetty.httpConfig.uriCompliance" default="RFC3986_UNAMBIGUOUS"/></Arg></Call></Set>
    <Set name="requestCookieCompliance"><Call class="org.eclipse.jetty.http.CookieCompliance" name="from"><Arg><Property name="jetty.httpConfig.requestCookieCompliance" default="RFC6265"/></Arg></Call></Set>
    <Set name="responseCookieCompliance"><Call class="org.eclipse.jetty.http.CookieCompliance" name="from"><Arg><Property name="jetty.httpConfig.responseCookieCompliance" default="RFC6265"/></Arg></Call></Set>
    <Set name="relativeRedirectAllowed"><Property name="jetty.httpConfig.relativeRedirectAllowed" default="false"/></Set>
    <Set name="useInputDirectByteBuffers" property="jetty.httpConfig.useInputDirectByteBuffers"/>
    <Set name="useOutputDirectByteBuffers" property="jetty.httpConfig.useOutputDirectByteBuffers"/>

    <!--
     Jetty 12's has a https://javadoc.jetty.org/jetty-12/org/eclipse/jetty/http/UriCompliance.html#DEFAULT as the default for
     Uri compliance and this strictly adheres to rfc3986.
     During testing of the upgrade to Jetty 12, we found that this was causing issues with cargo and npm scoped requests. Specifically, whenever
     a request was made to a scoped package the request would fail with a 400 error because of the forward slash '/' in the uri. for cargo, it is the same issue but cargo
     does not encode the forward slash '/' in the uri.
     Overriding this to what [LEGACY](https://javadoc.jetty.org/jetty-12/org/eclipse/jetty/http/UriCompliance.html#LEGACY) allowed seems reasonable
     and solved the problem with cargo and npm scoped requests that were failing.
     See https://jetty.org/docs/jetty/12/programming-guide/server/compliance.html#uri for uri compliance info
     See [UriCompliance](https://javadoc.jetty.org/jetty-12/org/eclipse/jetty/http/UriCompliance.html) class
     -->
    <!-- ForwardedRequestCustomizer must always be the first customizer -->
    <Call name="addCustomizer">
      <Arg>
        <New class="org.eclipse.jetty.server.ForwardedRequestCustomizer">
          <Set name="forwardedOnly" property="jetty.httpConfig.forwardedOnly"/>
          <Set name="proxyAsAuthority" property="jetty.httpConfig.forwardedProxyAsAuthority"/>
          <Set name="forwardedPortAsAuthority" property="jetty.httpConfig.forwardedPortAsAuthority"/>
          <Set name="forwardedHeader" property="jetty.httpConfig.forwardedHeader"/>
          <Set name="forwardedHostHeader" property="jetty.httpConfig.forwardedHostHeader"/>
          <Set name="forwardedServerHeader" property="jetty.httpConfig.forwardedServerHeader"/>
          <Set name="forwardedProtoHeader" property="jetty.httpConfig.forwardedProtoHeader"/>
          <Set name="forwardedForHeader" property="jetty.httpConfig.forwardedForHeader"/>
          <Set name="forwardedPortHeader" property="jetty.httpConfig.forwardedPortHeader"/>
          <Set name="forwardedHttpsHeader" property="jetty.httpConfig.forwardedHttpsHeader"/>
          <Set name="forwardedSslSessionIdHeader" property="jetty.httpConfig.forwardedSslSessionIdHeader"/>
          <Set name="forwardedCipherSuiteHeader" property="jetty.httpConfig.forwardedCipherSuiteHeader"/>
        </New>
      </Arg>
    </Call>
  </New>

  <Set name="defaultHandler">
    <New id="NexusHandler" class="org.sonatype.nexus.bootstrap.jetty.InstrumentedHandler">
      <Arg>
        <New id="NexusWebAppContext" class="org.eclipse.jetty.ee8.webapp.WebAppContext">
          <Set name="descriptor"><Property name="jetty.etc"/>/nexus-web.xml</Set>
          <Set name="parentLoaderPriority">true</Set>
          <Set name="defaultsDescriptor"><Property name="jetty.etc"/>/override-default-web.xml</Set>
          <Set name="contextPath"><Property name="nexus-context-path"/></Set>
          <Set name="throwUnavailableOnStartupException">true</Set>
          <Set name="configurationClasses">
            <Array type="java.lang.String">
              <Item>org.eclipse.jetty.ee8.webapp.WebXmlConfiguration</Item>
            </Array>
          </Set>
        </New>
      </Arg>
    </New>
  </Set>
  <Set name="handler">
    <New id="Contexts" class="org.eclipse.jetty.server.handler.ContextHandlerCollection">
      <Set name="dynamic" property="jetty.server.contexts.dynamic"/>
    </New>
  </Set>

  <Set name="stopAtShutdown"><Property name="jetty.server.stopAtShutdown" default="true"/></Set>
  <Set name="stopTimeout"><Property name="jetty.server.tempDirectory" default="5000"/></Set>
  <Set name="dumpAfterStart" property="jetty.server.dumpAfterStart"/>
  <Set name="dumpBeforeStop" property="jetty.server.dumpBeforeStop"/>
  <Set name="tempDirectory" property="jetty.server.tempDirectory"/>

  <Call id="MBeanServer" class="java.lang.management.ManagementFactory"
        name="getPlatformMBeanServer" />

  <Call name="addBean">
    <Arg>
      <New id="MBeanContainer" class="org.eclipse.jetty.jmx.MBeanContainer">
        <Arg>
          <Ref refid="MBeanServer" />
        </Arg>
        <Call name="beanAdded">
          <Arg/>
          <Arg>
            <Get name="ILoggerFactory" class="org.slf4j.LoggerFactory"/>
          </Arg>
        </Call>
      </New>
    </Arg>
  </Call>

</Configure>
